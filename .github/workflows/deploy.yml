name: deploy
on:
  push:
    branches:
      - deploy
jobs:
  aws-ec2-deploy:
    runs-on: ubuntu-latest
    env:
      REPO_PATH: ${{ github.workspace }}
      REPO: ${{ github.repository }}
    steps:
      - name: Set repo name
        run: echo "::set-env name=REPO_NAME::$(echo $REPO | cut -d / -f 2)"

      - name: Install SSH client and start ssh-agent.
        uses: webfactory/ssh-agent@v0.2.0
        with:
          ssh-private-key: ${{ secrets.AWS_EC2_DEPLOY_KEY }}

      - name: Clone and checkout.
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Deploy
        env:
          WEB_PATH: ${{ secrets.AWS_EC2_WEB_PATH }}
          SSH_DEST: ${{ secrets.AWS_EC2_SSH_DEST }}
        run: |
          rsync --progress --recursive --delete \
          --exclude .git/ --exclude .github/ --exclude .gitignore \
          --rsync-path="mkdir -p $WEB_PATH/$REPO_NAME && rsync" \
          -e "ssh -o StrictHostKeyChecking=no" \
          $REPO_PATH/. $SSH_DEST:$WEB_PATH/$REPO_NAME


